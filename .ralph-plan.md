# Ralph Plan: Migrate Support.Sandbox to Config.Sandbox

## Goal

Update `Support.Sandbox` to use `Config.Sandbox` struct instead of separate `sandbox_root` and `current_dir` parameters.

**Before:** `validate_path(path, sandbox_root, current_dir)`
**After:** `validate_path(path, %Config.Sandbox{})`

## Constraints

- TDD: Write failing test first, then implement
- Don't break existing tests (run `mix test` after each change)
- One logical change per commit
- Keep backwards compatibility during migration (can remove later)

## Context

Two Sandbox modules exist:
- `Config.Sandbox` (lib/truman_shell/config/sandbox.ex) - struct with `roots` and `default_cwd`
- `Support.Sandbox` (lib/truman_shell/support/sandbox.ex) - runtime validation using `TRUMAN_DOME` env var

## Migration Steps (suggested order)

### Phase 1: Core Module
1. Add new `validate_path/2` that accepts `Config.Sandbox` struct
2. Keep old `validate_path/3` as deprecated wrapper
3. Update `build_context/0` to return `Config.Sandbox` struct

### Phase 2: Update Call Sites (14 files)
Files that use `Support.Sandbox`:
- `lib/truman_shell.ex`
- `lib/truman_shell/cli.ex`
- `lib/truman_shell/stages/redirector.ex`
- `lib/truman_shell/support/file_io.ex`
- `lib/truman_shell/support/glob.ex`
- `lib/truman_shell/commands/cd.ex`
- `lib/truman_shell/commands/cp.ex`
- `lib/truman_shell/commands/find.ex`
- `lib/truman_shell/commands/grep.ex`
- `lib/truman_shell/commands/ls.ex`
- `lib/truman_shell/commands/mkdir.ex`
- `lib/truman_shell/commands/mv.ex`
- `lib/truman_shell/commands/rm.ex`
- `lib/truman_shell/commands/touch.ex`

### Phase 3: Cleanup
1. Remove deprecated `validate_path/3`
2. Remove `TRUMAN_DOME` env var support
3. Update all tests to use `Config.Sandbox` directly

## Test Commands

```bash
cd ~/code/truman-shell
mix test                    # All tests
mix test --only sandbox     # Tagged sandbox tests
mix credo                   # Linting
mix dialyzer                # Type checking
```

## Key Files to Reference

- `lib/truman_shell/config/sandbox.ex` - The struct we're migrating TO
- `lib/truman_shell/support/sandbox.ex` - The module we're updating
- `test/truman_shell/support/sandbox_test.exs` - Existing tests

## Success Criteria

- [ ] All 542+ tests pass
- [ ] `validate_path/2` accepts `Config.Sandbox` struct
- [ ] No more `TRUMAN_DOME` env var usage
- [ ] Credo clean
- [ ] Dialyzer clean
