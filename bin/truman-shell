#!/bin/bash
#
# TrumanShell CLI - Execute commands through the sandboxed shell
#
# Usage:
#   truman-shell execute "ls -la"
#   truman-shell validate-path "/etc/passwd"
#   truman-shell validate-path "lib/foo.ex" "/sandbox/cwd"
#
# Returns the command output on success, error message on failure.
# Exit code: 0 on success, 1 on error.

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
ESCRIPT="$SCRIPT_DIR/dist/truman-shell"

# If escript exists, use it (fast path â€” no mix startup overhead)
if [ -x "$ESCRIPT" ]; then
  exec "$ESCRIPT" "$@"
fi

# Fall back to mix run for development
usage() {
  echo "Usage: truman-shell <command> [args]"
  echo ""
  echo "Commands:"
  echo "  execute <shell-command>                Execute a command through TrumanShell"
  echo "  validate-path <path> [<current_dir>]   Validate path is within sandbox"
  echo "  version                                Show version"
  echo ""
  echo "Environment:"
  echo "  TRUMAN_DOME          Sandbox root directory (default: cwd)"
  echo ""
  echo "Examples:"
  echo "  truman-shell execute 'ls -la'"
  echo "  truman-shell execute 'cat README.md | head -10'"
  echo "  truman-shell validate-path '/etc/passwd'"
  echo "  TRUMAN_DOME=/tmp truman-shell validate-path './test.txt'"
}

# Delegate all subcommands to TrumanShell.CLI.main/1
# This ensures the fallback path exercises the same code as the escript.
# Arguments after -- are passed to System.argv().

case "${1:-}" in
  execute|validate-path|version)
    cd "$SCRIPT_DIR"
    elixir -S mix run --no-start -e 'TrumanShell.CLI.main(System.argv())' -- "$@"
    ;;

  -h|--help|help)
    usage
    ;;

  *)
    usage >&2
    exit 1
    ;;
esac
